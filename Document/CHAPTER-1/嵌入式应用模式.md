# 嵌入式应用模式

常见的嵌入式应用有2种：

1. 前后台系统

   前后台系统由前台、后台两部分构成。前台是中断处理程序，后台是一个大循环，大致的结构如下：

   ```c
   int event_flag1=0;
   int event_flag2=0;
   int event_flag3=0;
   
   extern void HandleEvent1(void);
   extern void HandleEvent2(void);
   extern void HandleEvent3(void);
   
   int main(void){
   	while(1){
           if(event_flag1){
               HandleEvent1();
           }
           if(event_flag2){
               HandleEvent2();
           }
           if(event_flag3){
               HandleEvent3();
           }
       }
   }
   
   void IRQ1_Handler(void){
       event_flag1 = 1;
       SimpleEvent1Process();
   }
   
   void IRQ2_Handler(void){
       event_flag2 = 1;
       SimpleEvent2Process();
   }
   
   void IRQ3_Handler(void){
       event_flag3 = 1;
   }
   ```

   - 前台程序（中端处理程序）的优先级比后台程序（大循环）的优先级高，当发生中断时，会停止大循环的执行，切换到中断对应的处理程序中。如果中断中只需要简单的设置一下标志位，如`event_flag1=1;`，或者记录一下事件发生的次数，如`event_count1++;`可以直接在中断处理程序中完成，但是如果处理过程比较复杂，占用CPU时间比较长，就需要尽快退出中断程序，在后台程序中进行处理；如果不及时退出，中断发生频率很高的情况下，会导致错过中断事件的情况；

   【优点】

   - 应用结构简单，对于逻辑简单的应用开发起来非常容易入手

   【缺点】

   - 应用逻辑复杂时，需要小心设计和处理
   - 需要在后台程序中进行多个条件判断，实时性不够，对实时性要求高的应用不太合适

   

2. 实时多任务系统

​	复杂的应用系统中，可以运行多个不同的任务：

1. 每个任务就像一个工人，专职负责一个任务；
2. 当任务相关的事件没有发生时，任务可以休息，不会占用系统资源；
3. 当任务相关的事件发生时，任务被唤醒，并继续执行；
4. 任务可以按重要程度划分优先级，A任务执行时，收到了B任务的事件，因为B事件更重要，需要马上处理，这时就需要先暂停A任务的执行，切换到B任务，当B任务完成后再回到A任务继续执行

实时多任务系统的结构如下:

```c
int event_flag1 = 0;
int event_flag2 = 0;
int event_flag3 = 0;

int main(void){
    Hardware_Init();
    RTOS_Init();
    Task1_Init();
    Task2_Init();
    Task3_Init();
    RTOS_Startup();
}

void IRQ1_Handler(void){
    event_flag1=1;
    RTOS_Notify(1);
}

void IRQ2_Handler(void){
    event_flag2=1;
    RTOS_Notify(2);
}

void IRQ3_Handler(void){
    event_flag3=1;
    RTOS_Notify(3);
}

void Task1(void* param){
    while(1){
        RTOS_Wait(1); /* Task1 will wait until RTOS_Notify(1) called */
        if(event_flag1){
            Handle_Event1();
        }
    }
}

void Task2(void* param){
    while(1){
        RTOS_Wait(2); /* Task2 will wait until RTOS_Notify(2) called */
        if(event_flag2){
            Handle_Event2();
        }
    }
}

void Task3(void* param){
    while(1){
        RTOS_Wait(3); /* Task3 will wait until RTOS_Notify(3) called */
        if(event_flag3){
            Handle_Event3();
        }
    }
}
```

【优点】

1. 实时性高，按事件重要程度响应，事件发生时立即调用对应的任务执行
2. 将系统功能划分为多个小任务，提升了系统的重用性，更容易测试，更好维护
3. 系统资源利用更合理，能将CPU执行时间划分为不同的小片段，想通优先级的任务，按时间片段轮流执行

【缺点】

1. 实时系统需要占用额外的CPU资源和内存、ROM等资源（最小系统在`5k-10k`左右）
